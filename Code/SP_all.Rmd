---
title: 'Effects of urban green infrastructure on supply provision of ecosystem service'
author: "Irina Lerner"
date: "30/01/24"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: paper
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("functions.R")
city = "SÃ£o Paulo"
```

# Variables

the variables used are as following

```{r predictors}
# predictor variables
predictors <- c("SVI", 
                "SGVI", 
                "SUVI", 
                "prop_veg")
```

# Data 

```{r 1km_data, include=FALSE}
# set city context
#shp_1km   <- "../Cities/SP/1km/data_two_ES.shp"
shp_1km   <- "../Cities/SP/1km/final_two_ES.shp"

DT  <- "DT"
SB <- "SBmean"

# Load data
data_1km <- edit_shp(st_read(shp_1km))

## minor adjustments
data_1km$sp_codigo <- data_1km$RM # for LST
data_1km$DT_wait2 <- data_1km$DT
data_1km$DT <- data_1km$DT_wait

data_1km$DTprov <- data_1km$DT*data_1km$pop_d
data_1km$SBprov <- data_1km$SBmean*data_1km$pop_d

data_1km$t <- data_1km$A + data_1km$B + data_1km$C + data_1km$no_data
data_1km$SVI <- data_1km$B/data_1km$t
data_1km$SGVI <- data_1km$C/data_1km$t
data_1km$SUVI <- data_1km$A/data_1km$t
data_1km$prop_na <- data_1km$no_data/data_1km$t
data_1km <- data_1km[data_1km$prop_na < 0.5, ]

```

```{r map_1km}
plot_map(data_1km)

library(plotly)
library(dplyr)

data_1km<- data_1km[data_1km$prop_veg < 0.6,]
plot_map(data_1km)

# Create a 3D scatter plot using plotly with proper command chaining
p <- plot_ly(data_1km, x = ~SVI, y = ~SUVI, z = ~SGVI, type = 'scatter3d', mode = 'markers',
             marker = list(size = 5, color = ~DT_wait, colorscale = 'Viridis', opacity = 0.8)) %>%
  layout(title = "3D Scatter Plot of SVI, SUVI, and SGVI",
         scene = list(xaxis = list(title = "SVI"),
                      yaxis = list(title = "SUVI"),
                      zaxis = list(title = "SGVI")))

p
```   

# Correlations

```{r 1km_correlation}
cor_mat <- as.data.frame(data_1km)[c(SB, DT, predictors)]
suppressWarnings(chart.Correlation(cor_mat, histogram=TRUE, pch=16, method = "spearman"))
```

Given high correlation among variables restricts us to the following models:

```{r 1km_models}
pred_1km <- c("1", predictors, 
              "SVI + prop_veg", 
              "SVI * prop_veg",
              "SVI + SGVI",
              "SVI * SGVI",
              "SVI + SUVI",
              "SVI * SUVI",
              "SVI * SEVI",
              "SGVI * SEVI",
              "SUVI * SEVI")

pred_1km <- c("1", "prop_veg", "SVI", 
              "SVI + prop_veg")
```

Moran I test also indicate a lot of spatial autocorrelation.

```{r DT_spatialcorr}
coords <- cbind(data_1km$centx, data_1km$centy)
weights <- nb2listw(dnearneigh(coords, 0, 10000), style = "W")
# Calculate Moran's I
moran.test(data_1km$DT, weights)
moran.test(data_1km$DTprov, weights)
```

# Climatic Amendment

Models for supply result in :

```{r LST}
LST <- spatial_models(data_1km, DT, pred_1km)
#LST <- non_spatial_models(data_1km, DT, pred_1km)
# save the best models to display later
best_LST <- select_best_models(LST)
AIC_eff_tab(LST, "LST")

avail_thr <- parallel::detectCores(logical=FALSE) - 1L 

mod <- fitme(DT ~ prop_veg + Cauchy(1 | centx + centy), data = data_1km, family = "gaussian",
             fixed=list(longdep=0.5,shape=0.5,rho=0.05),
             control.HLfit=list(NbThreads=max(avail_thr, 1L), 
                             algebra="spcorr"))

residuals(mod)
moran.test(residuals(mod), weights)
```

```{r LST_category}
plot_categories(data_1km, DT)

plot_PV_categories(data_1km, DT)
```

```{r LST_supply_landscapes}
# Load the raster
EVI <- "../Cities/SP/EVI/EVI_SP.tif"
plot_top_3(data_1km, DT, EVI, "id")
```

And for provision

```{r LST_prov}
LST_prov <- spatial_models(data_1km, "DTprov", pred_1km)
#LST_prov <- non_spatial_models(data_1km, "DTprov", pred_1km)
best_LST_prov <- select_best_models(LST)
AIC_eff_tab(LST_prov, "LST_prov")
```

``` {r LST_prov_category}
plot_categories(data_1km, "DTprov")

plot_PV_categories(data_1km, "DTprov")
```

```{r LST_prov_landscapes}
plot_top_3(data_1km, "DTprov", EVI, "id")
```

# Scenic Beauty

To work with scenic beauty we first remove the NA values from the table and add the count of points evaluated as a random effect.

```{r Scenic_beauty_adjustments}
data_1km$sp_codigo <- data_1km$SBcount
data_1km <- data_1km[!is.na(data_1km$SBmean),]
```

Again, Moran I test showed a lot of spatial correlation

```{r SB_spatialcorr}
coords <- cbind(data_1km$centx, data_1km$centy)
weights <- nb2listw(dnearneigh(coords, 0, 10000), style = "W")
# Calculate Moran's I
moran.test(data_1km$SBmean, weights)
moran.test(data_1km$SBprov, weights)
```

```{r Scenic_beauty}
SB_sup <- spatial_models(data_1km, SB, pred_1km)
#SB_sup <- non_spatial_models(data_1km, SB, pred_1km)
best_SB <- select_best_models(SB_sup)
AIC_eff_tab(SB_sup, "SB")
```

```{r SB_category}
plot_categories(data_1km, SB)

plot_PV_categories(data_1km, SB)
```

```{r SB_supply_landscapes}
plot_top_3(data_1km, SB, EVI, "id")
```

And provision

```{r Scenic_beauty_prov}
SB_prov <- spatial_models(data_1km, "SBprov", pred_1km)
#SB_prov <- non_spatial_models(data_1km, "SBprov", pred_1km)
best_SB_prov <- select_best_models(SB_prov)
AIC_eff_tab(SB_prov, "SBprov")
```

```{r SB_prov_category}
plot_categories(data_1km, "SBprov")

plot_PV_categories(data_1km, "SBprov")
```

```{r SB_prov_landscapes}
# Load the raster
EVI <- "../Cities/SP/EVI/EVI_SP.tif"
plot_top_3(data_1km, "SBprov", EVI, "id")
```

# Richness

To analyse richness we have to load another set of data.

```{r Rich_data, include=FALSE}
# set city context
shp_rich   <- "../Cities/SP/1km/richness_effort_1km.shp"
rich <- "richness"

# Load data
data_rich <- edit_shp(st_read("../Cities/SP/1km/richness_effort_1km.shp"))

## minor adjustments
data_rich$sp_codigo <- data_rich$effort
```

```{r map_rich}
plot_map(data_rich)
```   


```{r rich_correlation}
cor_mat <- as.data.frame(data_rich)[c(rich, predictors)]
suppressWarnings(chart.Correlation(cor_mat, histogram=TRUE, pch=16, method = "pearson"))
```

Holding the same predictors, Models result in :

```{r rich}
richn <- spatial_models(data_rich, rich, pred_1km, "poisson")
#richn <- non_spatial_models(data_rich, rich, pred_1km)
best_rich <- select_best_models(richn)
AIC_eff_tab(richn, "Richness")
```

```{r rich_category}
plot_categories(data_rich, rich)

plot_PV_categories(data_rich, rich)
```

In the case of a support service like biodiversity we only consider the supply.

```{r rich_supply_landscapes}
# Load the raster
EVI <- "../Cities/SP/EVI/EVI_SP.tif"
plot_top_3(data_rich, rich, EVI, "id")
```
