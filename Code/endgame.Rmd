---
title: "Effects of urban green infrastructure on supply provision of ecosystem service: Temperature reduction"
author: "Irina Lerner"
date: "30/01/24"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: paper
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("functions2.R")

# customs
custom_theme <- theme_minimal() +
                theme(text = element_text(size = 12),
                      plot.title = element_blank(),
                      panel.grid.major = element_blank(),
                      panel.grid.minor = element_blank())
```

# Data

```{r data100, include=FALSE}
# Load data
cdata <- edit_shp(st_read("../Cities/SP/100m/tryU.shp"))
# Temperature edit
cdata$LTM <- log(cdata$T_mean)

cdata$class[cdata$cd_perimet == 3832] <- "Urban"
cdata$class[cdata$cd_perimet != 3832] <- "none"
udata <- cdata[cdata$class == "Urban",]
#sbdata <- cdata[!is.na(cdata$SBmean),]
```

# Vegetation structure classes and continuum


```{r}
# Create neighbors list based on a distance threshold
plot_bi_map(udata, "EVI_mean", "Cat")
```

```{r}
cdata <- bi_class(cdata, x = cat, y = SVI, style = "fisher")
plot_bi_map(cdata, "EVI_mean", "EVI_lag")
```


```{r}
cdata <- bi_class(cdata, x = EVI_mean, y = Cat, style = "fisher")
cdata$surroundings <- as.character(cdata$bi_class)
cdata$surroundings[cdata$bi_class %in% c("1-1")] <- "U"
cdata$surroundings[cdata$bi_class %in% c("1-2")] <- "Sh"
cdata$surroundings[cdata$bi_class %in% c("1-3")] <- "Sp"

cdata$surroundings[cdata$bi_class %in% c("2-1")] <- "Sh"
cdata$surroundings[cdata$bi_class %in% c("2-2")] <- "Sh"
cdata$surroundings[cdata$bi_class %in% c("2-3")] <- "Sh"

cdata$surroundings[cdata$bi_class %in% c("3-1")] <- "SpG"
cdata$surroundings[cdata$bi_class %in% c("3-2")] <- "SpG"
cdata$surroundings[cdata$bi_class %in% c("3-3")] <- "G"

cdata$surroundings <- factor(cdata$surroundings)

summary(cdata$surroundings)

ggplot(cdata[cdata$class == "Urban",]) +
  geom_sf(aes(fill = EVI_mean), color = NA, size = 0.1) + 
  custom_theme
```


Since data is big and spatial, we start by defining a neighborhood list to add a spatial feature to the data. The surroundings will be considered to around 300 m

```{r}
# Create neighbors list based on a distance threshold
empty_geometries <- st_is_empty(udata)
data_clean <- udata[!empty_geometries, ]

coords <- st_centroid(cdata)
nb <- dnearneigh(coords, 0, 500)  # Neighbors within 0 to threshold distance
lw <- nb2listw(nb, style="W", zero.policy=TRUE)
moran.mc(cdata$EVI_mean, lw, nsim = 999)
```

Moran shows significant spatial autocorrelation. From the list, we can take an averaged-by-neighborhood measure of the EVI, the lag. This is a continuum representation of land sharing and land sparing. 

```{r}
cdata$EVI_lag <- lag.listw(lw, cdata$EVI_mean)
moran.mc(cdata$EVI_lag, lw, nsim = 999)

summary(lm(T_mean ~ EVI_mean, cdata))

ggplot(cdata) +
  geom_sf(aes(fill = EVI_lag), color = NA, size = 0.1) +  # Remove borders with colour = NA
  custom_theme
```

Now we have to find the global group each region is in to combine them




We can see how each class relate to EVI_lag

```{r}
group_colors <- c("darkgreen", "orange", "purple", "turquoise" , "red3")

cdata$group <- cdata$surroundings

med <- sort(tapply(cdata$EVI_lag, cdata$group, mean))
cdata$group <- factor(cdata$group, levels = names(med))
boxplot(EVI_lag ~ group, data = cdata,
    col = group_colors)
```

# Temperature

```{r}
group_colors <- c("darkgreen", "orange", "purple", "turquoise" , "red3")

med <- sort(tapply(cdata$T_mean, cdata$group, mean))
cdata$group <- factor(cdata$group, levels = names(med))
boxplot(T_mean ~ group, data = cdata,
    col = group_colors)
```

```{r}
interaction.plot(
  cdata$prop_veg,         # x-axis variable
  cdata$group,      # factor variable
  cdata$T_mean,              # response variable
  ylab = "LTM",  # y-axis label
  xlab = "PV",   # x-axis label
  col = group_colors,
)
```

```{r}
#add temperature lag?
# change all to gam?
T_null <- lm(T_mean ~ 1, data = cdata)
summary(T_null)
AIC(T_null)

T_PV <- lm(T_mean ~ prop_veg, data = cdata)
summary(T_PV)
AIC(T_PV)

T_EVI <- lm(T_mean ~ EVI_mean, data = cdata)
summary(T_EVI)
AIC(T_EVI)

T_lag <- lm(T_mean ~ EVI_lag, data = cdata)
summary(T_lag)
AIC(T_lag)

T_cat <- lm(T_mean ~ group, data = cdata)
Anova(T_cat, type = "III")
summary(T_cat)
```

```{r}
cdata$pop_d  <- cdata$pop/cdata$prop_ocup
plot_bi_map(cdata, "EVI_lag", "pop_d")
```

# Scenic beauty

# Biodiversity

```{r}
bdata <- st_read("../Cities/SP/1km/rich_final.shp")

bdata$SEVI <- (bdata$C - bdata$A)/(bdata$C + bdata$B + bdata$A + bdata$no_data)
bdata$REff <- bdata$richness/bdata$X.effort 
```

```{r}
bdata <- bi_class(bdata, x = SVI, y = SEVI, style = "jenks")
plot_bi_map(bdata, "SVI", "SEVI")
```


```{r}
bdata$surroundings <- as.character(bdata$bi_class)
bdata$surroundings[bdata$bi_class %in% c("1-1")] <- "SpU"
bdata$surroundings[bdata$bi_class %in% c("1-2")] <- "SpG + SpU"
bdata$surroundings[bdata$bi_class %in% c("1-3")] <- "SpG"

bdata$surroundings[bdata$bi_class %in% c("2-1")] <- "Sh + SpU"
bdata$surroundings[bdata$bi_class %in% c("2-2")] <- "Sh + SpG + SpU"
bdata$surroundings[bdata$bi_class %in% c("2-3")] <- "Sh + SpG"

bdata$surroundings[bdata$bi_class %in% c("3-1")] <- "Sh + SpU"
bdata$surroundings[bdata$bi_class %in% c("3-2")] <- "Sh"
bdata$surroundings[bdata$bi_class %in% c("3-3")] <- "Sh + SpG"

bdata$surroundings <- factor(bdata$surroundings)

summary(bdata$surroundings)

ggplot(bdata) +
  geom_sf(aes(fill = surroundings), color = NA, size = 0.1) +  # Remove borders with colour = NA
  custom_theme
```

We can see how each class relate to EVI_lag

```{r}
group_colors <- c("darkgreen", "lightgreen", "greenyellow", "gold", "orange", "red", "red4")

med <- sort(tapply(bdata$REff, bdata$surroundings, median))
bdata$group <- factor(bdata$surroundings, levels = names(med))
boxplot(log(REff) ~ surroundings, data = bdata,
    col = group_colors)
```

```{r}
interaction.plot(
  bdata$prop_veg,         # x-axis variable
  bdata$surroundings,      # factor variable
  bdata$REff,              # response variable
  ylab = "LTM",  # y-axis label
  xlab = "PV",   # x-axis label
  col = group_colors,
)
```

```{r}
#add temperature lag?
# change all to gam?
T_null <- lm(REff ~ 1, data = bdata)
summary(T_null)
AIC(T_null)

T_PV <- lm(REff ~ prop_veg, data = bdata)
summary(T_PV)
AIC(T_PV)

T_EVI <- lm(REff ~ EVI_mean, data = bdata)
summary(T_EVI)
AIC(T_EVI)

T_lag <- lm(REff ~ SVI, data = bdata)
summary(T_lag)
AIC(T_lag)

T_lag <- lm(REff ~ SGVI, data = bdata)
summary(T_lag)
AIC(T_lag)

T_cat <- lm(REff ~ SVI + SGVI, data = bdata)
Anova(T_cat, type = "III")
summary(T_cat)
```

```{r}
cdata$pop_d  <- cdata$pop/cdata$prop_ocup
plot_bi_map(cdata, "EVI_lag", "pop_d")
```


# Compiled

interaction plot? influence by area matrix with colors and the smooths.

# rest

```{r}
cdata <- bi_class(cdata, x = EVI_mean, y = pEVI, style = "jenks")
plot_bi_map(cdata, "EVI_mean", "pEVI")
```


```{r}
cdata$surroundings <- as.character(cdata$bi_class)
cdata$surroundings[cdata$bi_class %in% c("1-1")] <- "SpU.U"
cdata$surroundings[cdata$bi_class %in% c("1-2")] <- "SpU.M"
cdata$surroundings[cdata$bi_class %in% c("1-3")] <- "SpU.G"

cdata$surroundings[cdata$bi_class %in% c("2-1")] <- "Sh.U"
cdata$surroundings[cdata$bi_class %in% c("2-2")] <- "Sh.M"
cdata$surroundings[cdata$bi_class %in% c("2-3")] <- "Sh.G"

cdata$surroundings[cdata$bi_class %in% c("3-1")] <- "SpG.U"
cdata$surroundings[cdata$bi_class %in% c("3-2")] <- "SpG.M"
cdata$surroundings[cdata$bi_class %in% c("3-3")] <- "SpG.G"

cdata$surroundings <- factor(cdata$surroundings)

summary(cdata$surroundings)

ggplot(cdata) +
  geom_sf(aes(fill = surroundings), color = NA, size = 0.1) +  # Remove borders with colour = NA
  custom_theme
```


```{r}
cdata$finalgroups <- cdata$surroundings
med <- sort(tapply(cdata$T_mean, cdata$finalgroups, median))
cdata$finalgroups <- factor(cdata$finalgroups, levels = names(med))
boxplot(LTM ~ finalgroups, data = cdata,
    col = c("darkgreen", "lightgreen", "greenyellow", "yellow", "orange", "firebrick", "red"))
```
# Services

Finding how much in average each service is affected by category and surrounding

```{r}
# Define a vector of colors for each group
group_colors <- c("darkgreen", "lightgreen", "greenyellow", "yellow", "gold", "orange", "red", "red3", "red4")


```

Non-linearity can be seen with GAM:


```{r}
gam_SVI <- gam(T_mean ~ s(SVI, by = finalgroups), data = cdata, method = "ML")
plot(gam_SVI, all.terms = TRUE)
```

```{r}
gam_SGVI <- gam(T_mean ~ s(SGVI, by = finalgroups), data = cdata, method = "ML")
plot(gam_SGVI, all.terms = TRUE)
```

```{r}
data_df <- as.data.frame(cdata)
#data_df <- as.data.frame(cdata[cdata$surroundings %in% "M"])
part.lm = varpart(data_df$LTM, data_df[, c("prop_veg")], data_df[, c("PVdif1")], data_df[, c("PVdif2")])
# Plot with custom settings
plot(part.lm, digits = 2,
     bg = c(rgb(48, 225, 210, 80, maxColorValue = 255), 
            rgb(80, 48, 225, 210, maxColorValue = 255),
            rgb(210, 80, 48, 225, maxColorValue = 255)))

out1 <- rda(data_df$LTM, data_df[, c("SGVI")], data_df[, c("prop_veg")])
out2 <- rda(data_df$LTM, data_df[, c("prop_veg")], data_df[, c("SGVI")])

anova(out1, step = 1000, perm.max = 1000)
anova(out2, step = 1000, perm.max = 1000)
```

```{r}
Y <- scale(as.data.frame(cdata)[, "LTM"])  # Response variable, scaled
X <- scale(as.data.frame(cdata)[, c("EVI_mean", "prop_veg")])

Y <- as.data.frame(Y)
X <- as.data.frame(X)

pca_result <- prcomp(X, center = TRUE, scale = TRUE)

cdata$PC1 <- pca_result$x[, "PC1"]
cdata$PC2 <- pca_result$x[, "PC2"]

# Extract loadings
loadings_df <- as.data.frame(pca_result$rotation)
loadings_df$Variable <- rownames(pca_result$rotation)

ggplot() +
  geom_point(data = cdata, aes(x = PC1, y = PC2, color = LTM), size = 3) +
  geom_segment(data = loadings_df, aes(x = 0, y = 0, xend = PC1 * max(abs(cdata$PC1)), yend = PC2 * max(abs(cdata$PC2))),
               arrow = arrow(length = unit(0.2, "inches")), color = "black") +
  geom_text(data = loadings_df, aes(x = PC1 * max(abs(cdata$PC1)), y = PC2 * max(abs(cdata$PC2)), label = Variable), vjust = 1.5, color = "black") +
  theme_bw() +
  labs(title = element_blank(), x = "PC1", y = "PC2") +
  theme(legend.title = element_blank()) +
  coord_fixed()  # Ensures the plot is square
```

There is two principal components in this analysis, one related to proportion of vegetation, SGVI and SUVI and another more related to SVI that together compose separate variables.

we need to check if now the linear model looks fancy and good.

```{r}
rda_result <- rda(Y ~ ., data = as.data.frame(cdata)[,c("EVI_mean", "prop_veg")])

fwd.sel <- ordiR2step(rda(Y ~ 1, data = X), # lower model limit (simple!)
               scope = formula(rda_result), # upper model limit (the "full" model)
               direction = "forward",
               R2scope = TRUE, # can't surpass the "full" model's R2
               pstep = 1000,
               trace = FALSE) # change to TRUE to see the selection process!

fwd.sel$call # all vars were kept
rda_result$CCA$biplot
RsquareAdj(rda_result)

anova.cca(rda_result, step = 1000, by = "term")

# Type 1 scaling
ordiplot(rda_result, scaling = 1, type = "text")

cdata$RDA1 <- scores(rda_result, display = "sites")[,1]  # Adding the first RDA axis scores to the spatial data
cdata$PC1 <- scores(rda_result, display = "sites")[,2]  # Adding the second RDA axis scores to the spatial data

ggplot(cdata) +
  geom_sf(aes(fill = RDA1), color = NA) +  # Fill grid cells based on RDA1 scores
  scale_fill_viridis_c() +  # Use a continuous color scale
  labs(title = "Spatial Distribution of RDA Axis 1 Scores") +
  theme_minimal()

ggplot(cdata) +
  geom_sf(aes(fill = PC1), color = NA) +  # Fill grid cells based on RDA1 scores
  scale_fill_viridis_c() +  # Use a continuous color scale
  labs(title = "Spatial Distribution of RDA Axis 1 Scores") +
  theme_minimal()

ggplot() +
  geom_point(data = as.data.frame(cdata), aes(x = RDA1, y = LTM, color = prop_veg), alpha = 0.5) +
  scale_color_viridis_c(option = "turbo") +
  theme_minimal() +
  labs(title = "RDA Plot with Response and Explanatory Variables", x = "PC1", y = "T")
```