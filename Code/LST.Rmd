---
title: 'Effects of urban green infrastructure on supply provision of ecosystem service: temperature regulation'
author: "Irina Lerner"
date: "30/01/24"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: paper
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
getwd()
source("functions.R")
```

# Introduction

Urban areas, while only occupying 2% of the Earth's surface, impact deeply the environment, significantly affecting biodiversity [1] and human health and well-being [2]. Today, over half of the global population lives in urban centers, projected to rise to 70% by 2070 [3], especially in developing countries with limited infrastructure [4]. Despite the recognized benefits of urban green spaces for public health and species preservation, balancing spatial occupation with environmental conservation remains a challenge [5]. - add green experience

Green urban infrastructure extends beyond sheer vegetation quantity; it includes aspects of configuration, fragmentation, and type [5]. The concept of a space use gradient, originally developed to balance nature conservation and agricultural yield [6], can be modified to model conservation in urban settings, where this gradient is mirrored by population density variations, from total conservation of one area to total use elsewhere (sparing), passing through to moderate, uniform use (sharing) [7]. 

This study investigates how these different spatial configurations impact the benefits to human life that nature provides - the ecosystem services (E.S.) specifically, surface temperature regulation, scenic beauty, and recreation, in São Paulo for its importance as an urban center in a developing country such as Brazil. We hypothesize that the degrees of sharing and sparing directly influence the supply, flow, and demand of these services, aiming to inform sustainable urban vegetation management for optimized E.S. provision.

# Methodology

## Roadmap
We compare variables in statistical models to explore the relationship between the configuration of green infrastructure in an urban landscape and the supply of surface temperature regulation, scenic beauty and recreation. To model both the configuration of green spaces and E.S.’s supply, we subdivide the urban center of São Paulo into regions and assign sharing and sparing indexes, derived from vegetation data (fig 1, table 1) and indexes temperature variation, perception of beauty and availability of recreation spaces (fig 2, table 2).

## Landscape metrics

![SP](../Figures/SP_example.jpg)

 **Figure 1**: (I)  Map of São Paulo’s Enhanced Vegetation Index (EVI) and 1km² grid with regions of analysis. (II) A single grid cell and its corresponding resolution. For EVI, each 30m² cell is colored in a shade from green to red according to the amount of vegetation. (III) Histogram of grid II categorized in low (A), medium (B) and high (C) vegetation density. [8]
 
**Table 1**.  Calculation of sharing and sparing indexes based on São Paulo’s EVI. SVI = Sharing Vegetation index, SGVI = Sparing Green Vegetation Index, SUVI = Sparing Urban Vegetation Index, SEVI = Sparing Evenness Vegetation indexes. They represent proportions of areas of only urban, sharing and only green, and the balance between green and urban.

| Index | Formula                | Description                                             |
|-------|------------------------|---------------------------------------------------------|
| SVI   | $\frac{B}{(A + B + C)}$        | Proportion of areas with medium EVI (0,16 to 0,56)      |
| SGVI  | $\frac{C}{(A + B + C)}$        | Proportion of areas with high EVI (higher than 0,56)    |
| SUVI  | $\frac{A}{(A + B + C)}$        | Proportion of areas with low EVI (lower than 0,16)      |
| SEVI  | $\bigg(\frac{(A-C)}{(A+C)} + 1\bigg)\frac{1}{2}$| Normalized difference between the proportion of high and low vegetation areas |

For now, I'm not really sure I'll be using all the indexes. I still have to do some analysis to see what the best models look like.

## Ecosystem Services
 
<img src="../Figures/SE.png" width="300">

**Figure 2**: E.S. provision can be modeled as a graph where areas of demand (cities) and supply (vegetation) of different sizes are connected by the flow - how supply gets to the demand.


**Table 2**. Model elements for each of the E.S. selected; Row 1: surface temperature regulation: supply is the difference between the local max temperature and the max temperature of the region that reached the higher maximum in the same local climatic zone (T*max). Demand is the density of people in the area, and flow is local. Row 2: scenic beauty, the supply was estimated by conducting an online survey where participants were asked to choose between images from São Paulo based on beauty. Then, data was fed to a ML model that extrapolated results for the whole city. Demand is estimated by survey of people that live in the area, and the flow is local. Row 3: recreation: supply is the proportion of parks and woods. Demand was calculated by surveying people in those places, and estimating frequency of visiting. The flow is the distance they walk to go to those parks. A comparative score is assigned to supply and provision.

| Service                      | Supply                            | Demand      | Flow                     | Provision    |
|------------------------------|-----------------------------------|-------------|--------------------------|--------------|
| Surface temperature regulation | ΔTmax = T*max - Tmax             | population  | local                    | S x D        |
| Scenic beauty                | Estimated perception of beauty   | population  | local                    | S x D        |
| Biodiversity                   | Number of species seen    | (support service)  |   S | 


## Statistical Analysis

**Framework:** generalized linear mixed model (GLMM) with both random and fixed effects (FitMe from SpaMM package in R)

**Response variables (Y):** supply and provision of each service (tbl 2)

**Predictor variables (X):** sharing and sparing indexes, relationships and proportion of vegetation

**Fixed effects (fe):** depends on the service

**Random effects (re):** distance betwwen grid’s centroids as a matrix
Models were compared with Akaike’s Information Criteria (AIC)

## Data

The data for analysis was produced by Douglas Cirino and Arthur Lupinetti and treated by me.

```{r load, include=FALSE}
# set city context
city_name <- "São Paulo"
shp_file_path   <- "../Cities/SP/1km/final_please.shp"
out  <- "DT"

# Load data
shp <- st_read(shp_file_path)
```

```{r data}
shp$sp_codigo <- shp$RM
# remove isolated places and add centroids to data
data <- edit_shp(shp)
data$DT_wait2 <- data$DT
data$DT <- data$DT_wait
#data_urban <- data_urban[data_urban$prop_veg > 0.3,]
data_total <- as.data.frame(data)
data_total$SIVI2 <- 1 - data_total$SIVI
data_total$SEVI <- data_total$SIVI2
data_total$DT_supply <- data_total$DT
```
# References
[1] Simkin et al. (2022). Biodiversity impacts and conservation implications of urban land expansion. Proc Natl Acad Sci, 119(12).

[2] Goldstein (1990). Urbanization, health and well-being. J R Stat Soc Ser D (The Statistician), 39(2), 121-133.

[3] WHO (2010). Urbanization and health. Bull World Health Organ, 88(4), 245-246.

[4] Cohen (2006). Urbanization in developing countries. Technol Soc, 28(1-2), 63-80.

[5] Semeraro et al. (2021). Planning of urban green spaces. Land, 10(2), 105.

[6] Green et al. (2005). Farming and the fate of wild nature. Science, 307(5709), 550-555.

[7] Lin & Fuller (2013). How should we grow the world's cities? J Appl Ecol, 50(5)

[8] Cirino et al (2022). Balanced spatial distribution of green areas creates healthier urban landscapes. J Appl Ecol 59.7

# Supplementary Information

Here I'll explain the meaning behind every variable and how it was obtained.

**id:** identification code for the sample

**no_veg:** number of pixels without any vegetation

**forest:** number of pixels with forest cover

**open_veg:** number of pixels with open vegetation

**urb_trees:** number of pixels with urban trees

**DT:** Temperature regulation supply

**DT_wait:** Temperature regulation waiting variable

**no_data:** proportion of empty EVI values inside sample

**A:** number of low EVI values inside sample

**B:** number of medium EVI values inside sample

**C:** number of high EVI values inside sample

**prop_veg:** proportion of vegetation

**pop:** population

**pop_d** population density

**DT_prov:** provision of temperature regulation (DT*pop_d)

**RM:** microclimatic region 

- Add discussion about sample size and EVI values and histograms

- calculation of thresholds for each city

- Documents in EVI file (By Doug and me - In LEPAC)

I cleaned up the unused documents we've been using to create the final files. Ill document the step by step here on how I handled every file and what i remember.

  - Raster files
    - EVI_SP_final - speaks for itself - Has no water or grass
    - EVI_class - three classes corresponding to A, B and C, done with Zonal Histograms
    - EVI_SIRGAS - SIRGAS projection. Although it coincides with the map below
    - VEG_SIRGAS - Vegetation map in three classes to calculate total proportion of vegetation, classified by forest, urban trees and grass. Grass is used to remove from the main EVI map
    - Vector files
      - grid_1km_SIRGAS - grid used as my resolution for all data. Its perfectly alligned with DTMEAN and I honestly don't remember how I did it but I think its the built in grid tool.
      - DTMEAN - Arthur's pure results I'm using to get the temperature data from. 100x100m grid has area info as well. We use the column DTMEAN - Check with Arthur which column should I use
      - grid_populacao_2017_CZagua - File with 100x100m grid and population value. Both 100x100 have LCZ values. We use the column pop_piece_
      - municipio_SP has the city limits
      - vegetation_grid is the grid to count veg
    
We decided to do only supply

## Reunião Mê

SVI representa a variável de Land Sharing é a nossa variável de interesse. Sabemos que proporção de vegetação, não só por essa análise, mas também pela literatura, tem um efeito linear positivo na amenização climática representada por DT.

Para DT, valores positivos são bons e indicam maior amenização.

Nosso objetivo em seguida é entender como as diferentes formas de configuração desta vegetação afetam o sistema como um todo.

```{r first_lm, echo = FALSE}
lm_base <- lm(DT ~ prop_veg, data_total)
summary(lm_base)
AIC(lm_base)
```

Vemos que o valor de $R^2 = 0.93$ indica uma regressão bastante precisa. Como seria o modelo cheio?

```{r fullmodel, echo = FALSE}
lm_full <- lm(DT ~ SVI + SGVI + SUVI + SEVI + prop_veg, data_total)
summary(lm_full)
AIC(lm_full)

print("VIF")
VIF(lm_full)
```
Vemos que a colinearidade nestes modelos é altissima. Precisamos então escolher. A princípio, mantive SVI e SEVI, além de proporção de vegetação como base do modelo.

Vou tentar fazer um cálculo da importância relativa de cada varável usando este modelo: $R^2(full) - R^2(full-x)$.

```{r relative_importance, echo = FALSE}
print("Modelo cheio: DT ~ SVI + SEVI + prop_veg")
full <- lm(DT ~ SVI + SEVI + prop_veg, data_total)
summary(full)
AIC(full)

noSVI <- lm(DT ~ SEVI + prop_veg, data_total)
noSEVI <- lm(DT ~ SVI + prop_veg, data_total)

print("Importance of SVI in full model")
summary(full)$r.squared - summary(noSVI)$r.squared
sqrt(mean(noSVI$residuals^2)) - sqrt(mean(full$residuals^2))

print("Importance of SEVI in full model")
summary(full)$r.squared - summary(noSEVI)$r.squared
sqrt(mean(noSEVI$residuals^2)) - sqrt(mean(full$residuals^2))

print("VIF for full model")
VIF(full)

print("Importance of SVI considering only prop_veg")
summary(noSEVI)$r.squared - summary(lm_base)$r.squared
sqrt(mean(lm_base$residuals^2)) - sqrt(mean(noSEVI$residuals^2))

full2 <- lm(DT ~ SEVI + SVI, data_total)
summary(full2)
noSEVI2 <- lm(DT ~ SVI, data_total)
noSVI2 <- lm(DT ~ SEVI, data_total)

print("Importance of SVI considering only SVI + SEVI")
summary(full2)$r.squared - summary(noSVI2)$r.squared
sqrt(mean(noSVI2$residuals^2)) - sqrt(mean(full2$residuals^2))

print("Importance of SEVI considering only SVI + SEVI")
summary(full2)$r.squared - summary(noSEVI2)$r.squared
sqrt(mean(noSEVI2$residuals^2)) - sqrt(mean(full2$residuals^2))

```
Desta análise vemos que a importância relativa do Land Sparing, em DT, é muito alta, com SVI sendo pouco significativo no modelo cheio.

Isso nos indica que, idealmente, devemos tentar preservar melhor areas maiores para ter uma redução na temperatura, talvez?

Um olhar mais cauteloso sobre a tabela inicial de correlações indica que a relação do SVI com o DT não é linear, talvez seja quadrática. Podemos analisar do ponto de vista dos modelos lineares, adicionando o SVI como um termo quadrático, mas isso, pensando no efeito linear da proporção de vegetação não faria sentido.

# SVI

Vamos olhar então para o valor gráfico de SVI.

```{r SVI_plot, echo = FALSE}
data_total %>%
  ggplot(aes(x = SVI, y = DT, color = NULL)) +
  geom_point(alpha = .7) + 
  geom_smooth(method = "glm", alpha = .3) +
  scale_color_viridis_d(begin = .2) +
  geom_smooth(aes(color = NULL),
              color = "red", method = "glm", alpha = .3) +
  theme_bw()
```

Nesta imagem vemos que SVI tem duas tendências diferentes. Considerando que SVI, junto com SGVI e SUVI é uma proporção de características do espaço, podemos nos perguntar qual é a situação de SGVI e SUVI nos outros locais. SEVI marca a diferença entre ambos, e assim temos que um local que tem mais região urbana do que verde tem $SEVI < 0.5$ e uma região que tem mais verde que urbano tem $SEVI > 0.5$.

```{r SVI_explained, echo = FALSE}
data_total %>%
  ggplot(aes(x = SVI, y = DT, color = SEVI)) +
  geom_point(alpha = .7) + 
  geom_smooth(method = "glm", alpha = .3) +
  scale_color_viridis_c(begin = .2) +
  geom_smooth(aes(color = NULL),
              color = "red", method = "glm", alpha = .3) +
  theme_bw()
```

Classificando o SEVI em maior ou menor que meio, temos

```{r SVI_explained2, echo = FALSE}
data_total %>%
  ggplot(aes(x = SVI, y = DT, color = Class)) +
  geom_point(alpha = .7) + 
  geom_smooth(method = "glm", alpha = .3) +
  scale_color_viridis_d(begin = .2) +
  geom_smooth(aes(color = NULL),
              color = "red", method = "glm", alpha = .3) +
  theme_bw()
```

Aqui podemos observar duas tendências diferentes, dependendo do valor de SEVI, o que confunde a análise linear. 

Em seguida, segmentaremos os dados na região urbana e não urbana, onde o efeito do SVI é oposto.

# Fragmentação da cidade por SEVI.

```{r data_frag}
data_urban <- data_total[data_total$SEVI < 0.5,]
data_green <- data_total[data_total$SEVI >= 0.5,]
```

```{r corrs, echo=FALSE}
chart.Correlation(data_urban[c(out, predictor_variables)], histogram=TRUE, pch=16, method = "spearman")
chart.Correlation(data_green[c(out, predictor_variables)], histogram=TRUE, pch=16, method = "spearman")
```
Agora é possível ver mais claramente as relações entre SVI e as outras variáveis: Importa o que é o "resto".

```{r relative_importance_urban, echo = FALSE}
print("Modelo cheio: DT ~ SVI + SEVI")
full <- lm(DT ~ SVI + SEVI, data_urban)
summary(full)
AIC(full)

noSVI <- lm(DT ~ SEVI, data_urban)
noSEVI <- lm(DT ~ SVI, data_urban)

print("Importance of SVI in full model")
summary(full)$r.squared - summary(noSVI)$r.squared
sqrt(mean(noSVI$residuals^2)) - sqrt(mean(full$residuals^2))

print("Importance of SEVI in full model")
summary(full)$r.squared - summary(noSEVI)$r.squared
sqrt(mean(noSEVI$residuals^2)) - sqrt(mean(full$residuals^2))
```
Agora o SVI parece um pouco mais importante, apesar do valor de R quadrado do modelo ser bem pior. SVI parece ter significancia estatística.

Eu pessoalmente acredito que a diminuição no valor de $R^2$ em relação ao conjunto total de dados se dá porque, na escala mais urbana, a sombra dos prédios tem um efeito que não é possível ignorar.

Uma ideia é tentar entender se a interação entre os dois faz efeito (o efeito esperado de porpoção de vegetação, porque quando os dois aumentam, a propoção absoluta aumenta)

```{r relative_importance_urban2, echo = FALSE}
print("Modelo cheio: DT ~ SVI * SEVI")
full <- lm(DT ~ SVI * SEVI, data_urban)
summary(full)
AIC(full)

noSVI <- lm(DT ~ SEVI, data_urban)
noSEVI <- lm(DT ~ SVI, data_urban)

print("Importance of SVI in full model")
summary(full)$r.squared - summary(noSVI)$r.squared
sqrt(mean(noSVI$residuals^2)) - sqrt(mean(full$residuals^2))

print("Importance of SEVI in full model")
summary(full)$r.squared - summary(noSEVI)$r.squared
sqrt(mean(noSEVI$residuals^2)) - sqrt(mean(full$residuals^2))
```

Esse modelo parece de fato ser o mais significativo, com efeito positivo das duas variáveis mas negativo da interação?
