---
title: "IK WHAT IM DOING BITCH SAY WAA"
author: "Irina Lerner"
date: "27/06/24"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: paper
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("functions.R")
```

```{r data, include=FALSE}
# customs theme
custom_theme <- theme_minimal() +
                theme(text = element_text(size = 12),
                      plot.title = element_blank(),
                      panel.grid.major = element_blank(),
                      panel.grid.minor = element_blank())

# data loading 100m
shp100 <- st_read("../data/100_2_ES.shp")
data100 <- edit_shp(shp100)
alldata100 <- data100
ABdata100 <- alldata100[!is.na(alldata100$AB),]
CRdata100 <- alldata100[!is.na(alldata100$CR),]
POPdata100 <- alldata100[!is.na(alldata100$pop),]

# data loading 100m
shp <- st_read("../data/1km_2_ES.shp")
data <- edit_shp(shp)
alldata <- data
CRdata <- alldata[!is.na(alldata$CR),]
POPdata <- CRdata[!is.na(CRdata$pop),]
ABdata <- POPdata[!is.na(POPdata$AB),]
```

# Scale 

For climatic regulation 

```{r, echo=FALSE}
coords <- cbind(CRdata100$centx, CRdata100$centy)
xy <- st_centroid(CRdata100)

s.dist1  <-  dnearneigh(xy, 0, 200)  
s.dist2  <-  dnearneigh(xy, 0, 500)
s.dist3  <-  dnearneigh(xy, 0, 600)
s.dist4  <-  dnearneigh(xy, 0, 700)
s.dist5  <-  dnearneigh(xy, 0, 800)

lw1 <- nb2listw(s.dist1, style="W", zero.policy=T)
lw2 <- nb2listw(s.dist2, style="W", zero.policy=T) 
lw3 <- nb2listw(s.dist3, style="W", zero.policy=T) 
lw4 <- nb2listw(s.dist4, style="W", zero.policy=T) 
lw5 <- nb2listw(s.dist5, style="W", zero.policy=T) 

scale <- CRdata100
scale$SVI_lag1 <- lag.listw(lw1, scale$SVI)
scale$SVI_lag2 <- lag.listw(lw2, scale$SVI)
scale$SVI_lag3 <- lag.listw(lw3, scale$SVI)
scale$SVI_lag4 <- lag.listw(lw4, scale$SVI)
scale$SVI_lag5 <- lag.listw(lw5, scale$SVI)

scale$SGVI_lag1 <- lag.listw(lw1, scale$SGVI)
scale$SGVI_lag2 <- lag.listw(lw2, scale$SGVI)
scale$SGVI_lag3 <- lag.listw(lw3, scale$SGVI)
scale$SGVI_lag4 <- lag.listw(lw4, scale$SGVI)
scale$SGVI_lag5 <- lag.listw(lw5, scale$SGVI)

mod <- lm(CR ~ SVI + SGVI, scale)
mod1 <- lm(CR ~ SVI_lag1 + SGVI_lag1, scale)
mod2 <- lm(CR ~ SVI_lag2 + SGVI_lag2, scale)
mod3 <- lm(CR ~ SVI_lag3 + SGVI_lag3, scale)
mod4 <- lm(CR ~ SVI_lag4 + SGVI_lag4, scale)
mod5 <- lm(CR ~ SVI_lag5 + SGVI_lag5, scale)
summary(mod)

AIC(mod)
AIC(mod1)
AIC(mod2)
AIC(mod3)
AIC(mod4)
AIC(mod5)
```

For aesthetic beauty

```{r, echo=FALSE}
coords <- cbind(ABdata100$centx, ABdata100$centy)
xy <- st_centroid(ABdata100)

s.dist1  <-  dnearneigh(xy, 0, 200)  
s.dist2  <-  dnearneigh(xy, 0, 500)
s.dist3  <-  dnearneigh(xy, 0, 600)
s.dist4  <-  dnearneigh(xy, 0, 700)
s.dist5  <-  dnearneigh(xy, 0, 800)

lw1 <- nb2listw(s.dist1, style="W", zero.policy=T)
lw2 <- nb2listw(s.dist2, style="W", zero.policy=T) 
lw3 <- nb2listw(s.dist3, style="W", zero.policy=T) 
lw4 <- nb2listw(s.dist4, style="W", zero.policy=T) 
lw5 <- nb2listw(s.dist5, style="W", zero.policy=T) 

scale <- ABdata100
scale$SVI_lag1 <- lag.listw(lw1, scale$SVI)
scale$SVI_lag2 <- lag.listw(lw2, scale$SVI)
scale$SVI_lag3 <- lag.listw(lw3, scale$SVI)
scale$SVI_lag4 <- lag.listw(lw4, scale$SVI)
scale$SVI_lag5 <- lag.listw(lw5, scale$SVI)

scale$SGVI_lag1 <- lag.listw(lw1, scale$SGVI)
scale$SGVI_lag2 <- lag.listw(lw2, scale$SGVI)
scale$SGVI_lag3 <- lag.listw(lw3, scale$SGVI)
scale$SGVI_lag4 <- lag.listw(lw4, scale$SGVI)
scale$SGVI_lag5 <- lag.listw(lw5, scale$SGVI)

mod <- lm(CR ~ SVI + SGVI, scale)
mod1 <- lm(CR ~ SVI_lag1 + SGVI_lag1, scale)
mod2 <- lm(CR ~ SVI_lag2 + SGVI_lag2, scale)
mod3 <- lm(CR ~ SVI_lag3 + SGVI_lag3, scale)
mod4 <- lm(CR ~ SVI_lag4 + SGVI_lag4, scale)
mod5 <- lm(CR ~ SVI_lag5 + SGVI_lag5, scale)
summary(mod)

AIC(mod)
AIC(mod1)
AIC(mod2)
AIC(mod3)
AIC(mod4)
AIC(mod5)
```

For population 

```{r, echo=FALSE}
coords <- cbind(POPdata100$centx, POPdata100$centy)
xy <- st_centroid(POPdata100)

s.dist1  <-  dnearneigh(xy, 0, 200)  
s.dist2  <-  dnearneigh(xy, 0, 500)
s.dist3  <-  dnearneigh(xy, 0, 600)
s.dist4  <-  dnearneigh(xy, 0, 700)
s.dist5  <-  dnearneigh(xy, 0, 800)

lw1 <- nb2listw(s.dist1, style="W", zero.policy=T)
lw2 <- nb2listw(s.dist2, style="W", zero.policy=T) 
lw3 <- nb2listw(s.dist3, style="W", zero.policy=T) 
lw4 <- nb2listw(s.dist4, style="W", zero.policy=T) 
lw5 <- nb2listw(s.dist5, style="W", zero.policy=T) 

scale <- POPdata100
scale$SVI_lag1 <- lag.listw(lw1, scale$SVI)
scale$SVI_lag2 <- lag.listw(lw2, scale$SVI)
scale$SVI_lag3 <- lag.listw(lw3, scale$SVI)
scale$SVI_lag4 <- lag.listw(lw4, scale$SVI)
scale$SVI_lag5 <- lag.listw(lw5, scale$SVI)

scale$SGVI_lag1 <- lag.listw(lw1, scale$SGVI)
scale$SGVI_lag2 <- lag.listw(lw2, scale$SGVI)
scale$SGVI_lag3 <- lag.listw(lw3, scale$SGVI)
scale$SGVI_lag4 <- lag.listw(lw4, scale$SGVI)
scale$SGVI_lag5 <- lag.listw(lw5, scale$SGVI)

mod <- lm(CR ~ SVI + SGVI, scale)
mod1 <- lm(CR ~ SVI_lag1 + SGVI_lag1, scale)
mod2 <- lm(CR ~ SVI_lag2 + SGVI_lag2, scale)
mod3 <- lm(CR ~ SVI_lag3 + SGVI_lag3, scale)
mod4 <- lm(CR ~ SVI_lag4 + SGVI_lag4, scale)
mod5 <- lm(CR ~ SVI_lag5 + SGVI_lag5, scale)
summary(mod)

AIC(mod)
AIC(mod1)
AIC(mod2)
AIC(mod3)
AIC(mod4)
AIC(mod5)
```

# Results

```{r, echo=FALSE}
print("Proportion of vegetation and population of SÃ£o Paulo")
print(sum(alldata$pop, na.rm = TRUE))
```

## Correlation between variables

```{r, echo=FALSE}
cor_mat <- as.data.frame(alldata)[c("CR", "AB", "pop", "prop_veg", "SVI", "SGVI", "SUVI")]
suppressWarnings(chart.Correlation(cor_mat, histogram=TRUE, pch=16, method = "pearson"))
```

## Spatial Autocorrelation

```{r, echo=FALSE}
nb <- poly2nb(alldata)
lw <- nb2listw(nb, style="W", zero.policy=TRUE)

nbCR <- poly2nb(CRdata)
lwCR <- nb2listw(nbCR, style="W", zero.policy=TRUE)

nbSB <- poly2nb(ABdata)
lwSB <- nb2listw(nbSB, style="W", zero.policy=TRUE)

nbPOP <- poly2nb(POPdata)
lwPOP <- nb2listw(nbPOP, style="W", zero.policy=TRUE)

# Run Moran's I tests
moran_PV <- moran.mc(alldata$prop_veg, lw, nsim = 999)
moran_SVI <- moran.mc(alldata$SVI, lw, nsim = 999)
moran_SGVI <- moran.mc(alldata$SGVI, lw, nsim = 999)
moran_SUVI <- moran.mc(alldata$SUVI, lw, nsim = 999)
moran_CR <- moran.mc(CRdata$CR, lwCR, nsim = 999)
moran_AB <- moran.mc(ABdata$AB, lwSB, nsim = 999)
moran_pop <- moran.mc(POPdata$pop, lwPOP, nsim = 999)

# Create a data frame for the results
moran_results <- data.frame(
  Variable = c("PV", "SVI", "SGVI", "SUVI", "CR", "AB", "pop"),
  Moran_I = c(moran_PV$statistic, moran_SVI$statistic, moran_SGVI$statistic, moran_SUVI$statistic,  moran_CR$statistic, moran_AB$statistic, moran_pop$statistic),
  P_value = c(moran_PV$p.value, moran_SVI$p.value, moran_SGVI$p.value, moran_SUVI$p.value,  moran_CR$p.value, moran_AB$p.value, moran_pop$p.value))

moran_results
```

```{r, include = FALSE}
plot_PV <- plot_map(alldata, "prop_veg", "PV")
plot_SVI <- plot_map(alldata, "SVI", "SVI")
plot_SGVI <- plot_map(alldata, "SGVI", "SGVI")
plot_SUVI <- plot_map(alldata, "SUVI", "SUVI")
plot_CR <- plot_map(alldata, "CR", "CR")
plot_AB <- plot_map(alldata, "AB", "AB")
plot_pop <- plot_map(alldata, "pop", "pop")

legend_grob <- plot_dummy_legend()

# Combine the plots into a 2x2 layout
combined_plots <- grid.arrange(
  plot_PV, plot_SVI, plot_SGVI, plot_SUVI, plot_CR, plot_AB, plot_pop,
  ncol = 7,
  top = "")

final_plot <- arrangeGrob(
                    combined_plots,
                    legend_grob,
                    ncol = 1,
                    heights = c(2, 1.3))  # Adjust the relative heights as needed
```

```{r, echo=FALSE}
grid.arrange(final_plot)
```

## Trade-off between Sharing and Sparing

```{r, include=FALSE}
# Create individual plots without legends
plot_CR <- ggtern(data = CRdata, aes(x = SVI, y = SGVI, z = SUVI, color = CRn)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 8),
    plot.margin = unit(c(1, 1, 1, 1), "lines")
  ) +
  labs(title = "Climatic relief", x = "SVI", y = "SGVI", z = "SUVI", color = "")

plot_AB <- ggtern(data = ABdata, aes(x = SVI, y = SGVI, z = SUVI, color = ABn)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 8),
    plot.margin = unit(c(1, 1, 1, 1), "lines")
  ) +
  labs(title = "Aesthetic beauty", x = "SVI", y = "SGVI", z = "SUVI", color = "")

plot_pop <- ggtern(data = POPdata, aes(x = SVI, y = SGVI, z = SUVI, color = popn)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 8),
    plot.margin = unit(c(1, 1, 1, 1), "lines")
  ) +
  labs(title = "Population", x = "SVI", y = "SGVI", z = "SUVI", color = "")

# Combine the plots into a 2x2 layout
combined_plots <- grid.arrange(
  plot_CR, plot_AB, plot_pop,
  ncol = 3,
  top = ""
)

# Combine the plots with the shared legend at the bottom
final_plot <- arrangeGrob(
  combined_plots,
  legend_grob,
  ncol = 1,
  heights = c(10, 1.3)  # Adjust the relative heights as needed
)
```

```{r, echo=FALSE}
grid.arrange(final_plot)
```

## Service supply in $1km^2$

```{r, include=FALSE}
inter <- expand.grid(SVI = seq(0, 1, length.out = 50),
                       SGVI = seq(0, 1, length.out = 50))
inter <- inter[inter$SVI + inter$SGVI <= 1, ]
inter$SUVI <- 1 - inter$SVI - inter$SGVI
inter$centx <- mean(alldata$centx)
inter$centy <- mean(alldata$centy)

fixurban <- expand.grid(SVI = seq(0, 0.9, length.out = 1000))
fixurban$SUVI <- 0.1
fixurban$SGVI <- 1 - fixurban$SVI - fixurban$SUVI
fixurban$centx <- mean(alldata$centx)
fixurban$centy <- mean(alldata$centy)


fixsparing <- expand.grid(SVI = seq(0, 0.9, length.out = 1000))
fixsparing$SGVI <- 0.1
fixsparing$SUVI <- 1 - fixsparing$SVI - fixsparing$SGVI
fixsparing$centx <- mean(alldata$centx)
fixsparing$centy <- mean(alldata$centy)

fixsharing <- expand.grid(SGVI = seq(0, 0.9, length.out = 1000))
fixsharing$SVI <- 0.1
fixsharing$SUVI <- 1 - fixsharing$SVI - fixsharing$SGVI
fixsharing$centx <- mean(alldata$centx)
fixsharing$centy <- mean(alldata$centy)
```

### Linear models

We define models but only with variables that are less correlated than 0.6

```{r, include=FALSE}
pred <- c("1",
          "SVI",
          "SGVI",
          "SUVI",
          "SVI + SGVI",
          "SVI + SUVI",
          "SVI * SGVI",
          "SVI * SUVI",
          "prop_veg")

```

We perform model selection by comparing AIC in fitme models

```{r, echo=FALSE}
CR <- spatial_models(alldata, "CRn", pred)
AIC_eff_tab(CR, "CR")
```

```{r, echo=FALSE}
AB <- spatial_models(ABdata, "ABn", pred)
AIC_eff_tab(AB, "AB")
```

```{r, echo=FALSE}
POP <- spatial_models(alldata, "popn", pred)
AIC_eff_tab(POP, "pop")
```

```{r, include=FALSE}
# Predict values using the fitted model
inter$CRpredicted <- predict(CR[["SVI * SGVI"]], newdata = inter, type = "response")[,1]
inter$ABpredicted <- predict(AB[["SVI * SGVI"]], newdata = inter, type = "response")[,1]
inter$POPpredicted <- predict(POP[["SVI * SUVI"]], newdata = inter, type = "response")[,1]

# Create individual plots without legends
plot_CR <- ggtern(data = inter, aes(x = SVI, y = SGVI, z = SUVI, color = CRpredicted)) +
  geom_point(size = 3) +  # Adjust point size if needed
  scale_color_viridis_c() +  # Color gradient
  theme_bw() +  # Use a black and white theme
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 8),
    plot.margin = unit(c(1, 1, 1, 1), "lines")
  ) +
  labs(title = "(A) Climatic relief", x = "SVI", y = "SGVI", z = "SUVI", color = "")

plot_AB <- ggtern(data = inter, aes(x = SVI, y = SGVI, z = SUVI, color = ABpredicted)) +
  geom_point(size = 3) +  # Adjust point size if needed
  scale_color_viridis_c() +  # Color gradient
  theme_bw() +  # Use a black and white theme
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 8),
    plot.margin = unit(c(1, 1, 1, 1), "lines")
  ) +
  labs(title = "(B) Aesthetic Beauty", x = "SVI", y = "SGVI", z = "SUVI", color = "")

plot_pop <- ggtern(data = inter, aes(x = SVI, y = SGVI, z = SUVI, color = POPpredicted)) +
  geom_point(size = 3) +  # Adjust point size if needed
  scale_color_viridis_c() +  # Color gradient
  theme_bw() +  # Use a black and white theme
  theme(
    legend.position = "none",
    plot.title = element_text(size = 10),
    axis.title = element_text(size = 8),
    axis.text = element_text(size = 8),
    plot.margin = unit(c(1, 1, 1, 1), "lines")
  ) +
  labs(title = "(C) Population", x = "SVI", y = "SGVI", z = "SUVI", color = "")

# Combine the plots into a 2x2 layout
combined_plots <- grid.arrange(
  plot_CR, plot_AB, plot_pop,
  ncol = 3,
  top = ""
)

# Combine the plots with the shared legend at the bottom
final_plot <- arrangeGrob(
  combined_plots,
  legend_grob,
  ncol = 1,
  heights = c(10, 1.3)  # Adjust the relative heights as needed
)
```

```{r, echo=FALSE}
grid.arrange(final_plot)
```

```{r}
# Predict values using the fitted model
fixurban$CRpredicted <- predict(CR[["SVI * SGVI"]], newdata = fixurban, type = "response")[,1]
fixurban$ABpredicted <- predict(AB[["SVI * SGVI"]], newdata = fixurban, type = "response")[,1]
fixurban$POPpredicted <- predict(POP[["SVI * SUVI"]], newdata = fixurban, type = "response")[,1]

fixsharing$CRpredicted <- predict(CR[["SVI * SGVI"]], newdata = fixsharing, type = "response")[,1]
fixsharing$ABpredicted <- predict(AB[["SVI * SGVI"]], newdata = fixsharing, type = "response")[,1]
fixsharing$POPpredicted <- predict(POP[["SVI * SUVI"]], newdata = fixsharing, type = "response")[,1]

fixsparing$CRpredicted <- predict(CR[["SVI * SGVI"]], newdata = fixsparing, type = "response")[,1]
fixsparing$ABpredicted <- predict(AB[["SVI * SGVI"]], newdata = fixsparing, type = "response")[,1]
fixsparing$POPpredicted <- predict(POP[["SVI * SUVI"]], newdata = fixsparing, type = "response")[,1]


FU <- ggplot(fixurban) +
          geom_line(aes(x = SVI, y = normalize(CRpredicted), color = "Climatic Relief")) +
          geom_line(aes(x = SVI, y = normalize(ABpredicted), color = "Aesthetic Beauty")) +
          geom_line(aes(x = SVI, y = normalize(POPpredicted), color = "Population")) +
          labs(x = "SVI",
               y = "Fix Urban 0.1",
               color = "Model") +
          scale_color_manual(values = c("Climatic Relief" = "turquoise", "Aesthetic Beauty" = "purple", "Population" = "orange")) +
          theme_bw()

FS <- ggplot(fixsharing) +
          geom_line(aes(x = SGVI, y = scale(CRpredicted), color = "Climatic Relief")) +
          geom_line(aes(x = SGVI, y = normalize(ABpredicted), color = "Aesthetic Beauty")) +
          geom_line(aes(x = SGVI, y = normalize(POPpredicted), color = "Population")) +
          labs(x = "SGVI",
               y = "Fix Sharing 0.1",
               color = "Model") +
          scale_color_manual(values = c("Climatic Relief" = "turquoise", "Aesthetic Beauty" = "purple", "Population" = "orange")) +
          theme_bw()

FG <- ggplot(fixsparing) +
          geom_line(aes(x = SVI, y = scale(CRpredicted), color = "Climatic Relief")) +
          geom_line(aes(x = SVI, y = normalize(ABpredicted), color = "Aesthetic Beauty")) +
          geom_line(aes(x = SVI, y = normalize(POPpredicted), color = "Population")) +
          labs(x = "SVI",
               y = "Fix Green 0.1",
               color = "Model") +
          scale_color_manual(values = c("Climatic Relief" = "turquoise", "Aesthetic Beauty" = "purple", "Population" = "orange")) +
          theme_bw()

grid.arrange(
  FU, FS, FG,
  nrow = 3,
  top = ""
)
```

### Nonlinear models PROBS WITH COLINEARITY

We define models but only with variables that are less correlated than 0.6

```{r}
pred_gam <- c("1",
              "SVI",
              "SGVI",
              "SUVI",
              "prop_veg",
              "SVI + SGVI",
              "SVI + SUVI",
              "s(prop_veg)",
              "s(SVI)",
              "s(SGVI)",
              "s(SUVI)",
              "s(SVI) + s(SGVI)",
              "s(SVI) + s(SUVI)",
              "s(SVI) + s(SGVI) + s(SUVI)",
              "s(SVI, SGVI)",
              "s(SVI, SUVI)")
```

We perform model selection by comparing AIC in fitme models

```{r}
CR_gam <- gam_spatial_models(alldata, "CR", pred_gam)
AIC_tab_gam(CR_gam)
```

```{r}
AB_gam <- gam_spatial_models(ABdata, "AB", pred_gam)
AIC_tab_gam(AB_gam)
```

```{r}
POP_gam <- gam_spatial_models(alldata, "pop", pred_gam)
AIC_tab_gam(POP_gam)
```

```{r}
gam_CR <- gam(CR ~ s(SVI) + s(SUVI) + s(SGVI) + s(centx, centy), data = alldata, method = "ML")
AIC(gam_CR)
plot(gam_CR, all.terms = TRUE)
```

```{r}
gam_AB <- gam(AB ~ s(SVI) + s(SUVI) + s(SGVI) + s(centx, centy), data = alldata, method = "ML")
AIC(gam_AB)
plot(gam_AB, all.terms = TRUE)
```

```{r}
gam_POP <- gam(pop ~ s(SVI) + s(SUVI) + s(SGVI) + s(centx, centy), data = alldata, method = "ML")
AIC(gam_AB)
plot(gam_AB, all.terms = TRUE)
```

### RF

```{r}
data_rf <- data.frame(CR = ABdata$CR,
                      AB = ABdata$AB,
                      POP = ABdata$pop,
                      prop_veg = ABdata$prop_veg,
                      SGVI = ABdata$SGVI,
                      SVI = ABdata$SVI,
                      SUVI = ABdata$SUVI,
                      centx = scale(ABdata$centx),
                      centy = scale(ABdata$centy))
```

```{r}
# Fit Random Forest model
CR_rf <- randomForest(CR ~ SUVI + SGVI + SVI, data = data_rf, importance = TRUE)
# Plot variable importance
varImpPlot(CR_rf)
```

```{r}
# Fit Random Forest model
AB_rf <- randomForest(AB ~ SUVI + SGVI + SVI, data = data_rf, importance = TRUE)
# Plot variable importance
varImpPlot(AB_rf)
```

```{r}
# Fit Random Forest model
POP_rf <- randomForest(POP ~ SUVI + SGVI + SVI, data = data_rf, importance = TRUE)
# Plot variable importance
varImpPlot(POP_rf)
```

```{r}
# Predict values using the fitted model
fixurban$CRpredicted_rf <- predict(CR_rf, newdata = fixurban, type = "response")
fixurban$ABpredicted_rf <- predict(AB_rf, newdata = fixurban, type = "response")
fixurban$POPpredicted_rf <- predict(POP_rf, newdata = fixurban, type = "response")

fixsharing$CRpredicted_rf <- predict(CR_rf, newdata = fixsharing, type = "response")
fixsharing$ABpredicted_rf <- predict(AB_rf, newdata = fixsharing, type = "response")
fixsharing$POPpredicted_rf <- predict(POP_rf, newdata = fixsharing, type = "response")

fixsparing$CRpredicted_rf <- predict(CR_rf, newdata = fixsparing, type = "response")
fixsparing$ABpredicted_rf <- predict(AB_rf, newdata = fixsparing, type = "response")
fixsparing$POPpredicted_rf <- predict(POP_rf, newdata = fixsparing, type = "response")

FU <- ggplot(fixurban) +
      geom_smooth(aes(x = SVI, y = normalize(CRpredicted_rf)), method = "loess", formula = y ~ x, color = "turquoise") +
      geom_smooth(aes(x = SVI, y = normalize(ABpredicted_rf)), method = "loess", formula = y ~ x, color = "purple") +
      geom_smooth(aes(x = SVI, y = normalize(POPpredicted_rf)), method = "loess", formula = y ~ x, color = "orange") +
      labs(title = "(A) Replace sparing green with sharing",
           x = "SVI",
           y = "",
           color = "") +
      theme_bw() +
      theme(
        plot.title = element_text(size = 10),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 8),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())


FS <- ggplot(fixsharing) +
      geom_smooth(aes(x = SUVI, y = normalize(CRpredicted_rf)), method = "loess", formula = y ~ x, color = "turquoise") +
      geom_smooth(aes(x = SUVI, y = normalize(ABpredicted_rf)), method = "loess", formula = y ~ x, color = "purple") +
      geom_smooth(aes(x = SUVI, y = normalize(POPpredicted_rf)), method = "loess", formula = y ~ x, color = "orange") +
      labs(title = "(B) Replace sparing urban with sparing green",
           x = "SUVI",
           y = "",
           color = "") +
      theme_bw() +
      theme(
        plot.title = element_text(size = 10),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 8),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

FGr <- ggplot(fixsparing) +
      geom_smooth(aes(x = SUVI, y = normalize(CRpredicted_rf)), method = "loess", formula = y ~ x, color = "turquoise") +
      geom_smooth(aes(x = SUVI, y = normalize(ABpredicted_rf)), method = "loess", formula = y ~ x, color = "purple") +
      geom_smooth(aes(x = SUVI, y = normalize(POPpredicted_rf)), method = "loess", formula = y ~ x, color = "orange") +
      labs(title = "(C) Replace sparing urban with sharing",
           x = "SUVI",
           y = "",
           color = "") +
      theme_bw() +
      theme(
        plot.title = element_text(size = 10),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 8),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

legend2 <- cowplot::get_plot_component(FG, 'guide-box-right', return_all = TRUE)
  
legend_grob2 <- cowplot::ggdraw(legend2)

grid.arrange(
  FU, FS, FGr, legend_grob2,
  ncol = 4,
  nrow = 1,
  top = ""
)
```

### multivariate regression tree

```{r}
train_data <- as.data.frame(alldata)#[train_indices, ]

# Define the training datasets
X_train <- train_data %>% select(SVI, SUVI, SGVI, centx, centy)
#X_train <- train_data %>% select(SVI, SGVI, SUVI)
Y_train <- train_data %>% select(CRn, ABn, popn)

# Combine the response variables into a matrix
response <- cbind(SBmean = Y_train$CRn,  Y_train$ABn, Y_train$popn)

mvpart_model <- mvpart(response ~ ., data = X_train,
                    xv = "1se", # select smallest tree within 1 se
                    xval = nrow(response), # number of cross-validations
                    xvmult = 100, # number of multiple cross-validations
                    size = 6,
                    which = 4,
                    legend = FALSE, margin = 0.01, cp = 0, prn = F)
```

```{r}
# Plot the cross-validated error to find the optimal tree size
plotcp(mvpart_model)
```

```{r}
# Add the leaf nodes to your data
alldata$LeafNode <- as.factor(as.numeric(predict(mvpart_model, newdata = alldata, type = "where")))
# Plot the map, coloring by the leaf node
ggplot(data = alldata) +
  geom_sf(aes(fill = LeafNode), color = NA) +
  scale_fill_viridis_d() +  # Use a discrete color scale
  theme_minimal() +
  custom_theme +
    theme(legend.position = "none",
          plot.title = element_text(size = 10),
          axis.text = element_blank())
```

Now we make a boxplot for each node

```{r, echo = F}
# Colors for each variable
colors <- c("turquoise", "purple", "orange")

# Unique LeafNodes
leaf_nodes <- unique(alldata$LeafNode)

# Set up plotting area to display multiple plots
par(mfrow = c(1, 6), mar = c(4, 4, 2, 1))

# Create a boxplot for each LeafNode
for (node in sort(leaf_nodes)) {
  subset_data <- alldata[alldata$LeafNode == node, ]
  
  boxplot(subset_data$CRn, subset_data$ABn, subset_data$popn,
              names = c("CR", "AB", "pop"),
              col = colors,
            ylim = c(0, 1))
}


# Loop through each leaf node and create a plot
plots <- list()
i = 1
for (node in sort(leaf_nodes)) {
 p <- ggplot(data = alldata) +
    geom_sf(aes(fill = ifelse(LeafNode == node, as.character(node), "Other")), color = NA) +
    scale_fill_manual(values = c(setNames(viridis::viridis(length(leaf_nodes)), leaf_nodes), "Other" = "gray")) +  # Custom colors
    custom_theme +
    theme(legend.position = "none",
          plot.title = element_text(size = 10),
          axis.text = element_blank())
  
 plot(p)
  plots[[i]] <- p
}

# Combine all map plots into one layout
combined_plot <- marrangeGrob(grobs = plots, ncol = 3, nrow = 2)

# Display the combined map plot
grid.newpage()
grid.draw(combined_plot)

```
